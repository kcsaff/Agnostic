<html>
<head>

<!--

# Copyright (C) 2010 by Kevin Saff

# This file is part of Agnostic.

# Agnostic is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# Agnostic is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with Agnostic.  If not, see <http://www.gnu.org/licenses/>.

-->


<script type="text/javascript">

<!-- Howdy -->

<!-- Begin

//document.onmousedown = mouseDown;
document.onmousemove = mouseMove;
document.onmouseup = mouseUp;
//document.contextmenu = doNothing;

var currentObject = null;
var mouseOffset = null;
var mouseFirstPos = null;
var currentFirstRotation = 0;

var currentAction = null;
var currentFlipped = false;

var betterAction = null;

function doNothing(ev) {
}

function mouseCoords(ev) {
	if (ev.pageX || ev.pageY) {
		return {x:ev.pageX, y:ev.pageY};
	}
	return {
		x:ev.clientX + document.body.scrollLeft - document.body.clientLeft,
		y:ev.clientY + document.body.scrollTop - document.body.clientTop
	};
}

function getMouseOffset(target, ev) {
	ev = ev || window.event;
	var docPos = getPosition(target);
	var mousePos = mouseCoords(ev);
	return {x:mousePos.x - docPos.x, y:mousePos.y - docPos.y};
}

function getPosition(e) {
	var left = 0;
	var top = 0;
	
	while (e.offsetParent) {
		left += e.offsetLeft;
		top += e.offsetTop;
		e = e.offsetParent;
	}
	left += e.offsetLeft;
	top += e.offsetTop;
	
	return {x:left, y:top};
}

var whichButton = [0, 'left', 'middle', 'right']; //most
var buttonButton = ['left', 'left', 'right', 0, 'middle']; //IE

function getButton(event) {
    if (event.which) {
        return whichButton[event.which];
    }
    else {
        return buttonButton[event.button];
    }
}

function moveToEnd(array, item) {
	if (array.length < 1) return false;
	if (array[array.length - 1] === item) return false;
	var found = -1;
	for (var i = 0; i < array.length; ++i) {
		if (array[i] === item) {
			found = i;
			break;
		}
	}
	if (found == -1) return false;
	for (var i = found; i < array.length - 1; ++i) {
		array[i] = array[i + 1];
	}
	array[array.length - 1] = item;
	return true;
}

function fixZOrder(array) {
	for (var i = 0; i < array.length; ++i) {
		array[i].style.zIndex = i;
	}
}

var draggables = new Array();
var oneTime = 0;

function isPositionInBox(pos, obj) {
	if (oneTime-- > 0) {
		alert('x: ' + pos.x + ', y:' + pos.y +
			  ',\n l:' + obj.style.left + ', t:' + obj.style.top +
			  ',\n w:' + obj.width + ', h:' + obj.height +
			  ',\n tl:' + typeof obj.left + ', tt:' + typeof obj.top +
			  ',\n tw:' + typeof obj.width + ', th:' + typeof obj.height 
			  );
	}
	var left = parseInt(obj.style.left);
	var top = parseInt(obj.style.top);
	if (pos.x < left) {
		return false;
	}
	if (pos.x > left + obj.width) {
		return false;
	}
	if (pos.y < top) {
		return false;
	}
	if (pos.y > top + obj.height) {
		return false;
	}
	return true;
}

function getObjectCenter(obj) {
	var left = parseInt(obj.style.left);
	var top = parseInt(obj.style.top);
	return {x: left + obj.width / 2, y: top + obj.height / 2};
}

function getRelativeRotation(center, first, last) {
    return Math.atan2(last.y  - center.y, last.x  - center.x) 
         - Math.atan2(first.y - center.y, first.x - center.x);
}

function getRelativePosition(pos, obj) {
	var left = parseInt(obj.style.left)
	var top = parseInt(obj.style.top)
	var result = "in";
	var badness = 0;
	var bad = [left - pos.x, pos.x - (left + obj.width),
			   top - pos.y, pos.y - (top + obj.height)];
    var names = ["left", "right", "up", "down"];
    for (var i=0; i < 4; ++i) {
        if (bad[i] > badness) {
		    badness = bad[i];
		    result = names[i];
		}
	}
    
	return result;
}



function degreesToRadians(deg) {
	return Math.PI * 2 * deg / 360;
}

function radiansToDegrees(rad) {
	return rad * 360 / (Math.PI * 2);
}

function cleanupDegrees(deg) {
	deg = deg % 360;
	while (deg < 0) deg += 360;
	snapping = arguments[1] || 90;
	closeness = arguments[2] || 10;
	for (var snap=0; snap < 360; snap += snapping) {
		if (Math.abs(deg - snap) < closeness) deg = snap;
        }
        return deg;
}

function dragMove(object, event) {
    result = {};
    result.object = object;
    result.mouseOffset = getMouseOffset(object, event);
    result.move = function (mousePos) {
        this.object.style.position = 'absolute';
        this.object.style.top = mousePos.y - this.mouseOffset.y;
        this.object.style.left = mousePos.x - this.mouseOffset.x;
        if (moveToEnd(draggables, this.object)) {
            fixZOrder(draggables);
        }
        return false;
    }
    return result;
}

function _dragMove(mousePos) {
    currentObject.style.position = 'absolute';
    currentObject.style.top = mousePos.y - mouseOffset.y;
    currentObject.style.left = mousePos.x - mouseOffset.x;
    if (moveToEnd(draggables, currentObject)) {
        fixZOrder(draggables);
    }
		
    return false;
}

function dragFlip(mousePos) {
    currentObject.style.position = "absolute";
    var shouldFlip = !isPositionInBox(mousePos, currentObject);
    if (shouldFlip && !currentFlipped && currentObject.flip) {
        first = currentObject.flip.shift();
        currentObject.flip.push(first);
        currentFlipped = shouldFlip;
    }
    else if (!shouldFlip && currentFlipped && currentObject.flip) {
        //last = currentObject.flip.pop();
        //currentObject.flip.unshift(last);
        //currentFlipped = shouldFlip;
    }
    currentObject.src = currentObject.flip[0];
    return false; 
}

function dragFlipAndRotate(mousePos) {

    currentObject.style.position = "absolute";
    var relativePosition = getRelativePosition(mousePos, currentObject);
    if (currentObject.images[relativePosition]) {
        currentObject.src = currentObject.images[relativePosition];
    }
    if (currentObject.rotations[relativePosition] !== undefined) {
        transform = "rotate(" + currentObject.rotations[relativePosition] + "deg)";
        currentObject.style.webkitTransform = transform;
        currentObject.style.MozTransform = transform;
    }
    return false;
}

function dragArbitraryRotate(mousePos) {
    newRotation = getRelativeRotation(getObjectCenter(currentObject),
                                      mouseFirstPos,
                                      mousePos);
    //alert(newRotation);
    currentObject.currentRotation = cleanupDegrees(currentFirstRotation 
                                                   + radiansToDegrees(newRotation));
    transform = "rotate(" + currentObject.currentRotation + "deg)";
    currentObject.style.webkitTransform = transform;
    currentObject.style.MozTransform = transform;
    //alert("rotated!");
    return false;
}

function mouseMove(ev) {
	ev = ev || window.event;
	var mousePos = mouseCoords(ev);
	if (betterAction && getButton(ev)) {
	    return betterAction.move(mousePos);
	}
	else if (currentObject && currentAction && getButton(ev)) {
	    return currentAction(mousePos);
	}
}

function mouseDown(ev) {
}

function mouseUp() {
	betterAction = null;
	currentObject = null;
	currentAction = null;
	return false;
}

function makeDraggable(item) {
	if (!item) return;
	item.onmousedown = function(ev) {
		if (getButton(ev) == 'left' && ev.altKey) {
			currentObject = this;
			currentAction = dragFlipAndRotate;
			mouseMove(ev);
		}
		else if (getButton(ev) == 'left' && ev.shiftKey) {
			currentObject = this;
			currentAction = dragArbitraryRotate;
			currentFirstRotation = this.currentRotation || 0;
                        mouseFirstPos = mouseCoords(ev);
			mouseMove(ev);
		} 
		else if (getButton(ev) == 'left' && ev.ctrlKey) {
			currentObject = this;
			currentAction = dragFlip;
			currentFlipped = false;
			mouseMove(ev);
		} 
		else if (getButton(ev) == 'left') {
			betterAction = dragMove(this, ev);
			mouseMove(ev);
			//currentObject = this;
			//mouseOffset = getMouseOffset(this, ev);
			//currentAction = dragMove;
			//mouseMove(ev);
		} 
		return false;
	}
	draggables.push(item);
	//item.style.position = 'absolute';
}

function createCard(front, back) {
    card = document.createElement("img");
    card.src = front;
    card.images = {
				   'left': front,
				   'right': back,
				   'up': front,
				   'down': back,
					};
    card.rotations = {
					'left': 90,
					'right': 90,
					'up': 0,
					'down': 0,
					};
    card.flip = [front, back];
    makeDraggable(card);
    card.style.position = "absolute";
    card.style.top = 100;
    card.style.left = 100;
    card.style.zIndex = 1;
	card.src = front;
	document.getElementById("cards").appendChild(card);
	//document.getElementById("cards").onmousedown = mouseDown;
    return card;
}


// End -->
</script>

</head>

<div id="cards">
Drag left mouse button to move.<br />
Hold shift and drag to rotate.<br />
Hold alt and drag to flip.<br />
</div>

<body>


<script type="text/javascript">
<!-- 

createCard("../card/clubs-3-75.png", "../card/back-blue-75-1.png");
createCard("../card/clubs-5-75.png", "../card/back-blue-75-1.png");

 //-->
 </script>

</body>

</html>
